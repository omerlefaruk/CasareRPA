# Widget Rules

## Key Imports

```python
# File path widgets
from casare_rpa.presentation.canvas.graph.node_widgets import NodeFilePathWidget, NodeDirectoryPathWidget

# Theme for type colors/badges
from casare_rpa.presentation.canvas.ui.theme import get_type_color, get_type_badge, TYPE_COLORS, TYPE_BADGES

# Variable picker
from casare_rpa.presentation.canvas.ui.widgets.variable_picker import (
    VariableInfo, VariableProvider, VariableButton, VariablePickerPopup, VariableAwareLineEdit
)
```

## File Path Widgets

> Any node with file_path/directory_path inputs MUST use custom browse widgets.

### Available Widgets
| Widget | Use For |
|--------|---------|
| `NodeFilePathWidget` | Individual files (CSV, JSON, images) |
| `NodeDirectoryPathWidget` | Directories/folders |

### Import
```python
from casare_rpa.presentation.canvas.graph.node_widgets import NodeFilePathWidget, NodeDirectoryPathWidget
```

### Conflict Resolution
`@properties` auto-generates widgets BEFORE manual code runs. Use `_replace_widget()`:

```python
def _replace_widget(node: VisualNode, widget) -> None:
    """Replace auto-generated widget with custom widget."""
    prop_name = widget._name
    if hasattr(node, "model") and prop_name in node.model.custom_properties:
        del node.model.custom_properties[prop_name]
        if hasattr(node, "_widgets") and prop_name in node._widgets:
            del node._widgets[prop_name]
    node.add_custom_widget(widget)
    widget.setParentItem(node.view)
```

### Usage
```python
# File widget
_replace_widget(
    self,
    NodeFilePathWidget(
        name="file_path",          # Must match PropertyDef name
        label="CSV File",
        file_filter="CSV Files (*.csv);;All Files (*.*)",
        placeholder="Select CSV file...",
    ),
)

# Directory widget
_replace_widget(
    self,
    NodeDirectoryPathWidget(
        name="directory_path",
        label="Output Folder",
        placeholder="Select output folder...",
    ),
)
```

### Signal Handling (CRITICAL)
Qt `setText()` does NOT emit `editingFinished` signal!

```python
# CORRECT pattern:
def on_browse():
    path, _ = QFileDialog.getOpenFileName(...)
    if path:
        line_edit.setText(path)
        widget.on_value_changed()  # CRITICAL: Manual sync after setText()
```

### Categories Using These Widgets
- file_operations/ - CSV, JSON, Excel, Text, INI, XML
- desktop_automation/ - LaunchApplication, Screenshots, OCR
- browser/ - ScreenshotNode
- office_automation/ - ExcelOpen, WordOpen

---

## Variable Picker

> All text-based node properties include a variable picker button `{x}`.

### Supported PropertyTypes
STRING, TEXT, FILE_PATH, DIRECTORY_PATH, CODE, JSON, SELECTOR

### Triggers
| Action | Result |
|--------|--------|
| Click `{x}` button | Opens popup |
| `Ctrl+Space` | Opens popup |
| Type `{{` | Triggers autocomplete |

### Variable Syntax
```
{{varName}}           - Simple variable
{{data.field}}        - Nested Dict access
{{list[0]}}           - List index access
{{$currentDate}}      - System variable
```

### System Variables
| Variable | Value |
|----------|-------|
| `$currentDate` | Current date (YYYY-MM-DD) |
| `$currentTime` | Current time (HH:MM:SS) |
| `$currentDateTime` | ISO datetime |
| `$timestamp` | Unix timestamp |

### Variable Sources
1. Workflow variables (Variables tab)
2. Upstream node outputs
3. System variables

### Implementation
File: `ui/widgets/variable_picker.py`

Classes:
- `VariableInfo` - Dataclass for metadata
- `VariableProvider` - Singleton provider
- `VariableButton` - The `{x}` button
- `VariablePickerPopup` - Dropdown with search
- `VariableAwareLineEdit` - QLineEdit with picker

### Type Badges (from Theme)

**NEVER hardcode badge colors.** Use Theme helpers:

```python
from casare_rpa.presentation.canvas.ui.theme import get_type_color, get_type_badge

color = get_type_color("string")   # Returns #4ec9b0
badge = get_type_badge("integer")  # Returns "#"
```

| Type | Badge | Color | Usage |
|------|-------|-------|-------|
| String | T | `get_type_color("string")` | Text values |
| Integer | # | `get_type_color("integer")` | Whole numbers |
| Float | . | `get_type_color("float")` | Decimal numbers |
| Boolean | ? | `get_type_color("boolean")` | True/False |
| List | [] | `get_type_color("list")` | Arrays |
| Dict | {} | `get_type_color("dict")` | Objects |
| Any | * | `get_type_color("any")` | Generic |
| None | âˆ… | `get_type_color("none")` | Null values |

### Integration
Auto-generated by `@properties` via `_add_variable_aware_text_input()` in base_visual_node.py.

### Wire Colors (from Theme)

For port/wire coloring based on data type:
```python
from casare_rpa.presentation.canvas.ui.theme import get_wire_color

color = get_wire_color("exec")     # Execution flow
color = get_wire_color("string")   # String data
color = get_wire_color("number")   # Numeric data
color = get_wire_color("list")     # List/array data
color = get_wire_color("dict")     # Dictionary data
color = get_wire_color("table")    # Table/DataFrame data
```
