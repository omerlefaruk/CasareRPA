# Epic 7.1: Dialog Framework v2 - Implementation Plan

**Created**: 2025-12-30
**Status**: Planning
**Epic**: 7.1 - Dialog framework v2

## Overview

Standardize dialog components with v2 design system:
- Consistent title area, body padding, footer button placement
- Primary/secondary/destructive button variants
- Keyboard shortcuts (Enter = primary, Esc = cancel)
- No QGraphicsDropShadowEffect, no animations
- Full THEME_V2/TOKENS_V2 integration

## Dependencies

- Phase 5 complete (primitives v2, forms v2)
- PopupWindowBase (Epic 3.1) - for pattern reference
- styles_v2.py with get_dialog_styles_v2()

## Class Structure

```
BaseDialogV2 (QDialog)
    ├── DialogFooter (QWidget) - Button row with layout rules
    │   ├── ButtonRole enum (primary, secondary, destructive, cancel)
    │   └── DialogButton (PushButton wrapper with role)
    └── DialogTitleBar (QFrame) - Optional draggable title area

MessageBoxV2 (BaseDialogV2)
    └── Standardized message boxes (info, warning, error, question)

ConfirmDialogV2 (BaseDialogV2)
    └── Destructive action confirmations
```

## Files to Create

| File | Purpose | Lines (est) |
|------|---------|-------------|
| `ui/dialogs_v2/__init__.py` | Module exports | ~30 |
| `ui/dialogs_v2/base_dialog_v2.py` | BaseDialogV2, DialogFooter, DialogTitleBar | ~400 |
| `ui/dialogs_v2/message_box_v2.py` | MessageBoxV2, factory functions | ~250 |
| `ui/dialogs_v2/confirm_dialog_v2.py` | ConfirmDialogV2 for destructive actions | ~150 |
| `ui/dialogs_v2/_styles.py` | Dialog-specific QSS generators (or extend styles_v2.py) | ~200 |
| `tests/presentation/canvas/ui/dialogs_v2/test_base_dialog_v2.py` | BaseDialogV2 tests | ~300 |
| `tests/presentation/canvas/ui/dialogs_v2/test_message_box_v2.py` | MessageBoxV2 tests | ~250 |
| `tests/presentation/canvas/ui/dialogs_v2/test_confirm_dialog_v2.py` | ConfirmDialogV2 tests | ~200 |

## Files to Modify

| File | Changes |
|------|---------|
| `theme_system/styles_v2.py` | Extend `get_dialog_styles_v2()` with footer/titlebar classes |
| `ui/dialogs/__init__.py` | Add v2 imports behind feature flag |
| `ui/_index.md` | Document dialogs_v2 module |

## API Surface

### BaseDialogV2

```python
class BaseDialogV2(QDialog):
    """Base class for v2 dialogs with standardized layout and behavior."""
    
    # Signals
    accepted = Signal()      # User clicked primary action
    rejected = Signal()      # User clicked cancel or pressed Esc
    
    def __init__(
        self,
        title: str,
        parent: QWidget | None = None,
        size: DialogSize = DialogSize.MD,
        resizable: bool = False,
    )
    
    # Layout
    def set_title_widget(self, widget: QWidget) -> None
    def set_body_widget(self, widget: QWidget) -> None
    def set_footer_visible(self, visible: bool) -> None
    
    # Buttons
    def add_button(self, text: str, role: ButtonRole, slot: Callable | None = None) -> DialogButton
    def set_primary_button(self, text: str, slot: Callable | None = None) -> DialogButton
    def set_cancel_button(self, text: str = "Cancel") -> DialogButton
    
    # State
    def validate(self) -> bool  # Override in subclasses
    def set_validation_error(self, message: str) -> None
```

### DialogFooter

```python
class DialogFooter(QWidget):
    """Footer widget with standardized button layout."""
    
    def __init__(
        self,
        primary_text: str = "OK",
        cancel_text: str = "Cancel",
        show_apply: bool = False,
        parent: QWidget | None = None,
    )
    
    def add_button(self, text: str, role: ButtonRole) -> QPushButton
    def set_primary_enabled(self, enabled: bool) -> None
    def set_primary_text(self, text: str) -> None
```

### ButtonRole Enum

```python
class ButtonRole(Enum):
    PRIMARY = "primary"       # Main action, right-aligned or last
    SECONDARY = "secondary"   # Additional actions
    DESTRUCTIVE = "danger"    # Destructive actions (delete, etc.)
    CANCEL = "cancel"         # Cancel action, Esc key binding
```

### MessageBoxV2

```python
class MessageBoxV2(BaseDialogV2):
    """Standardized message box dialogs."""
    
    # Factory functions
    @staticmethod
    def show_info(parent: QWidget, title: str, message: str) -> None
    @staticmethod
    def show_warning(parent: QWidget, title: str, message: str) -> None
    @staticmethod
    def show_error(parent: QWidget, title: str, message: str) -> None
    @staticmethod
    def show_question(parent: QWidget, title: str, message: str) -> bool
```

## Dialog Sizes (from TOKENS_V2)

| Size | Width | Height | Use Case |
|------|-------|--------|----------|
| SM | 380 | 270 | Simple confirmations, single-field forms |
| MD | 550 | 400 | Standard forms, settings panels |
| LG | 750 | 700 | Complex forms, multi-tab dialogs |

## Button Placement Rules

1. **Right-align** action buttons (standard Qt pattern)
2. **Order** (left to right): Cancel (destructive/secondary) -> Apply -> Primary (OK)
3. **Primary** button gets Enter key binding
4. **Cancel** button gets Esc key binding
5. **Destructive** buttons use error color variant

## Keyboard Handling

| Key | Action | Notes |
|-----|--------|-------|
| Enter | Trigger primary button | Skip if text widget has focus |
| Esc | Trigger cancel/reject | Event filter on text widgets |
| Tab | Navigate forward | Standard Qt tab order |
| Shift+Tab | Navigate backward | Standard Qt tab order |

## Styling (THEME_V2)

All colors from THEME_V2, spacing from TOKENS_V2:
- Background: `THEME_V2.bg_surface`
- Border: `THEME_V2.border`
- Title: `THEME_V2.text_primary`, typography.heading_md
- Body padding: `TOKENS_V2.spacing.md` (8px)
- Footer padding: `TOKENS_V2.spacing.sm` (6px)
- Footer border-top: `1px solid THEME_V2.border`
- Button radius: `TOKENS_V2.radius.sm` (3px)
- Dialog radius: `TOKENS_V2.radius.lg` (6px)

## Test Approach

### Unit Tests

1. **BaseDialogV2**
   - Title area renders correctly
   - Body widget padding matches TOKENS_V2
   - Footer button order: secondary -> primary
   - Enter triggers primary when not in text input
   - Esc triggers cancel/reject
   - Size constraints (SM/MD/LG)
   - Resizable vs fixed behavior
   - Validation error display

2. **DialogFooter**
   - Button order preserved
   - Primary button gets correct variant
   - Destructive button gets danger variant
   - Buttons disabled/enabled correctly

3. **MessageBoxV2**
   - Info/Warning/Error icons display
   - Question dialog returns bool
   - Modal behavior blocks parent
   - Escape closes all variants

4. **ConfirmDialogV2**
   - Destructive action highlighted
   - Cancel button default
   - Confirm requires explicit click

### Integration Tests

- Open from NewMainWindow
- Center on parent
- Focus management (activateWindow, raise_)
- Click-outside does NOT close (different from popups)
- Multiple dialogs stack correctly

## Parallel Opportunities

1. **Create files in parallel**:
   - base_dialog_v2.py
   - message_box_v2.py
   - confirm_dialog_v2.py
   - _styles.py

2. **Write tests in parallel** after implementation:
   - test_base_dialog_v2.py
   - test_message_box_v2.py
   - test_confirm_dialog_v2.py

3. **Use PushButton from primitives v2**:
   - Import `from casare_rpa.presentation.canvas.ui.widgets.primitives.buttons import PushButton`
   - Use variant="primary", variant="danger"

## Implementation Steps

### Step 1: Create Module Structure
- Create `ui/dialogs_v2/` directory
- Create `__init__.py` with exports
- Create `_styles.py` (or extend styles_v2.py)

### Step 2: Implement DialogFooter
- QWidget with QHBoxLayout
- Right-aligned buttons
- ButtonRole variant mapping
- Use PushButton from primitives v2

### Step 3: Implement BaseDialogV2
- Inherit from QDialog
- QVBoxLayout: title_area, body, footer
- Size constraints from TOKENS_V2
- Keyboard event handling
- Validation pattern

### Step 4: Implement MessageBoxV2
- Icon + message layout
- Factory functions (show_info, show_warning, show_error, show_question)
- Modal behavior

### Step 5: Implement ConfirmDialogV2
- Destructive confirmation pattern
- Warning message display
- Cancel as default

### Step 6: Write Tests
- Unit tests for each class
- Keyboard handling tests
- Validation tests

### Step 7: Documentation
- Update ui/_index.md
- Add usage examples in docstrings
- Create sample dialog using v2 components

## Risks and Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Esc key handling in text widgets | Medium | Use eventFilter pattern from PopupWindowBase |
| Enter key conflicts with text input | Low | Check focused widget type before triggering |
| Button order inconsistency | Medium | Enforce order in DialogFooter layout |
| Theme drift (hardcoded colors) | Low | Linter rule + code review |
| Modal dialog blocking main window | Low | Test with NewMainWindow |

## Migration Path

Legacy dialogs remain in `ui/dialogs/`. New v2 dialogs in `ui/dialogs_v2/`.
Migration happens per-dialog (Epic 7.3):

1. Identify high-priority dialogs (MessageBox, confirmations)
2. Replace with v2 variants
3. Delete legacy implementations
4. Update imports

## Done When

- [ ] BaseDialogV2 passes all tests (title, body, footer, keyboard)
- [ ] MessageBoxV2 shows info/warning/error/question correctly
- [ ] ConfirmDialogV2 highlights destructive actions
- [ ] All dialogs use THEME_V2 (zero hardcoded colors)
- [ ] No QGraphicsDropShadowEffect in any dialog
- [ ] No animations (0ms transitions)
- [ ] @Slot decorator on all slot methods
- [ ] No lambda connections (use functools.partial)
- [ ] Tests pass: `pytest tests/presentation/canvas/ui/dialogs_v2/ -v`

## Rollback

- Keep legacy `ui/dialogs/` untouched
- v2 dialogs are opt-in via import path
- Delete `ui/dialogs_v2/` directory to revert

## References

- PopupWindowBase pattern: `ui/widgets/popups/popup_window_base.py`
- Primitives v2: `ui/widgets/primitives/`
- Tokens v2: `theme_system/tokens_v2.py`
- Styles v2: `theme_system/styles_v2.py`
- UX Plan: `docs/UX_REDESIGN_PLAN.md` Epic 7.1
