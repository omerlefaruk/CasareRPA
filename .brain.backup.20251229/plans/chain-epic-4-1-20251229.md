# Epic 4.1: NewMainWindow Skeleton (Dock-Only Workspace) - Implementation Plan

**Created**: 2025-12-29
**Status**: ✅ COMPLETE
**Phase**: Phase 4 — IDE Shell v2
**Epic**: 4.1

---

## Scope

Build `NewMainWindow` with dock-only workspace:
- Central workspace: NodeGraphQt graph widget
- Dock containers on left/right/bottom
- Tabbed docks
- **Dock-only enforcement**: remove floatable features, disallow detached windows
- Persist layout using `QSettings` and "Reset Layout"

---

## Dependencies Met

| Epic | Status | Required |
|------|--------|----------|
| Epic 0.1 (NewMainWindow stub) | ✅ Complete | YES |
| Epic 1.1 (Token spec v2) | ✅ Complete | YES |
| Epic 1.2 (Font bundling) | ✅ Complete | YES |
| Epic 1.3 (Global QSS v2) | ✅ Complete | YES - `get_canvas_stylesheet_v2()` exists |

---

## Files to Modify

| File | Action | Key Changes |
|------|--------|-------------|
| `src/casare_rpa/presentation/canvas/new_main_window.py` | MODIFY | Replace stub UI with dock layout, add layout persistence |
| `src/casare_rpa/presentation/canvas/theme_system/styles_v2.py` | MODIFY | Add QSS for placeholder panel contents |
| `tests/presentation/canvas/test_new_main_window.py` | CREATE | Unit tests for dock layout, persistence, reset |

---

## Implementation Details

### 1. Dock Layout Structure

```
┌─────────────────────────────────────────────────────────────┐
│  NewMainWindow (QMainWindow)                                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌─────────────────────────┐  ┌───────────┐ │
│  │          │  │                         │  │           │ │
│  │  Left    │  │   Central Widget        │  │  Right    │ │
│  │  Dock    │  │   (NodeGraphWidget)     │  │  Dock     │ │
│  │          │  │                         │  │           │ │
│  │          │  │                         │  │           │ │
│  ├──────────┤  └─────────────────────────┘  ├───────────┤ │
│  │          │  ┌─────────────────────────┐  │           │ │
│  │ Bottom   │  │                         │  │           │ │
│  │ Dock     │  │   (tabbed with left)    │  │           │ │
│  │          │  │                         │  │           │ │
│  └──────────┘  └─────────────────────────┘  └───────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. Panel Layout (from UX_REDESIGN_PLAN.md)

| Position | Panel(s) | Default |
|----------|----------|---------|
| Left | Project Explorer | Hidden (until Epic 6) |
| Right | Properties/Inspector | Hidden (until Epic 6) |
| Bottom | Output/Logs + Errors/Validation | Hidden (until Epic 6) |

**For Epic 4.1**: Create placeholder dock widgets that can be toggled via menu or shortcuts. Actual panel content comes in Epic 6.

### 3. Dock-Only Enforcement

```python
# CRITICAL: No floating docks allowed
dock.setFeatures(
    QDockWidget.DockWidgetFeature.DockWidgetMovable |
    QDockWidget.DockWidgetFeature.DockWidgetClosable
    # NO DockWidgetFloatable!
)
```

### 4. Layout Persistence Pattern

```python
from PySide6.QtCore import QSettings

class NewMainWindow(QMainWindow):
    _KEY_GEOMETRY = "geometry"
    _KEY_WINDOW_STATE = "windowState"
    _KEY_LAYOUT_VERSION = "layoutVersion"

    def save_layout(self) -> None:
        """Save window geometry and dock state to QSettings."""
        settings = QSettings("CasareRPA", "CanvasV2")
        settings.setValue(self._KEY_GEOMETRY, self.saveGeometry())
        settings.setValue(self._KEY_WINDOW_STATE, self.saveState())
        settings.setValue(self._KEY_LAYOUT_VERSION, 1)

    def restore_layout(self) -> None:
        """Restore window geometry and dock state from QSettings."""
        settings = QSettings("CasareRPA", "CanvasV2")
        geometry = settings.value(self._KEY_GEOMETRY)
        state = settings.value(self._KEY_WINDOW_STATE)

        if geometry:
            self.restoreGeometry(geometry)
        if state:
            self.restoreState(state)

    def reset_layout(self) -> None:
        """Reset to default layout."""
        settings = QSettings("CasareRPA", "CanvasV2")
        settings.clear()
        # Re-setup default dock arrangement
        self._setup_docks()
```

### 5. Corner Behavior

```python
# Force bottom docks to use bottom corners (prevents odd layouts)
self.setCorner(Qt.Corner.BottomRightCorner, Qt.DockWidgetArea.BottomDockWidgetArea)
self.setCorner(Qt.Corner.BottomLeftCorner, Qt.DockWidgetArea.BottomDockWidgetArea)

# Enable dock nesting (allows complex layouts)
self.setDockNestingEnabled(True)
```

### 6. Placeholder Dock Content

For Epic 4.1, use simple placeholder widgets:

```python
def _create_placeholder_dock(self, title: str, object_name: str, area: Qt.DockWidgetArea) -> QDockWidget:
    """Create a placeholder dock widget with minimal content."""
    dock = QDockWidget(title, self)
    dock.setObjectName(object_name)

    # Dock-only features
    dock.setFeatures(
        QDockWidget.DockWidgetFeature.DockWidgetMovable |
        QDockWidget.DockWidgetFeature.DockWidgetClosable
    )

    # Placeholder content
    from PySide6.QtWidgets import QLabel, QWidget, QVBoxLayout

    content = QWidget()
    layout = QVBoxLayout(content)
    layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

    label = QLabel(f"{title}\n(Coming in Epic 6)")
    label.setProperty("class", "placeholder")
    label.setStyleSheet(f"color: {THEME_V2.text_disabled};")

    layout.addWidget(label)
    dock.setWidget(content)

    # Add to main window
    self.addDockWidget(area, dock)

    # Connect state changes to auto-save
    dock.dockLocationChanged.connect(self._schedule_layout_save)
    dock.visibilityChanged.connect(self._schedule_layout_save)

    return dock
```

---

## Code Changes Summary

### new_main_window.py

**Replace `_setup_stub_ui()` with:**

1. `_setup_docks()` - Create placeholder dock widgets
2. `_setup_layout_persistence()` - QSettings, save/restore/reset
3. `_schedule_layout_save()` - Debounced save on dock changes
4. `save_layout()`, `restore_layout()`, `reset_layout()` - Public API
5. Menu action for "View → Reset Layout"

**Add placeholder dock widgets:**
- `_left_dock` - Project Explorer (hidden by default)
- `_right_dock` - Properties/Inspector (hidden by default)
- `_bottom_dock` - Output/Logs (hidden by default)

---

## Tests to Create

### tests/presentation/canvas/test_new_main_window.py

```python
import pytest
from PySide6.QtCore import Qt, QSettings, QByteArray
from casare_rpa.presentation.canvas.new_main_window import NewMainWindow


@pytest.mark.ui
class TestNewMainWindowDocks:
    """Test dock widget creation and layout."""

    def test_creates_dock_widgets(self, qapp):
        window = NewMainWindow()
        assert hasattr(window, "_left_dock")
        assert hasattr(window, "_right_dock")
        assert hasattr(window, "_bottom_dock")

    def test_docks_not_floatable(self, qapp):
        window = NewMainWindow()
        for dock in [window._left_dock, window._right_dock, window._bottom_dock]:
            features = dock.features()
            assert QDockWidget.DockWidgetFeature.DockWidgetFloatable not in features
            assert QDockWidget.DockWidgetFeature.DockWidgetMovable in features
            assert QDockWidget.DockWidgetFeature.DockWidgetClosable in features


@pytest.mark.ui
class TestNewMainWindowLayoutPersistence:
    """Test layout save/restore/reset."""

    def test_save_restores_geometry(self, qapp, tmp_path):
        # Use temp settings file
        window = NewMainWindow()
        window.resize(800, 600)
        window.move(100, 100)
        window.save_layout()

        # Create new window and restore
        window2 = NewMainWindow()
        window2.restore_layout()

        assert window2.size() == window.size()
        assert window2.pos() == window.pos()

    def test_reset_clears_settings(self, qapp):
        window = NewMainWindow()
        window.save_layout()
        window.reset_layout()

        settings = QSettings("CasareRPA", "CanvasV2")
        assert not settings.value("geometry")
        assert not settings.value("windowState")

    def test_corner_behavior_enforced(self, qapp):
        window = NewMainWindow()
        assert window.corner(Qt.Corner.BottomRightCorner) == Qt.DockWidgetArea.BottomDockWidgetArea
        assert window.corner(Qt.Corner.BottomLeftCorner) == Qt.DockWidgetArea.BottomDockWidgetArea


@pytest.mark.ui
class TestNewMainWindowSignals:
    """Test signal emissions."""

    def test_all_workflow_signals_exist(self, qapp):
        window = NewMainWindow()
        required_signals = [
            "workflow_new", "workflow_open", "workflow_save",
            "workflow_run", "workflow_stop",
        ]
        for sig_name in required_signals:
            assert hasattr(window, sig_name)
```

---

## Manual Test Checklist

- [ ] App launches in v2 mode (`CASARE_UI_V2=1`)
- [ ] Docks can be resized by dragging splitter
- [ ] Docks can be moved to different areas
- [ ] Docks cannot float (float button disabled)
- [ ] Docks can be closed and reopened via View menu
- [ ] Docks can be tabbed (drag one dock onto another)
- [ ] Layout persists after restart
- [ ] "Reset Layout" restores defaults
- [ ] No animations on dock show/hide
- [ ] No hardcoded colors in code (uses THEME_V2)

---

## Rollback Plan

Keep existing stub code as backup:
- `_setup_stub_ui()` becomes `_setup_stub_ui_legacy()`
- Feature flag controls which method is called
- If issues arise, revert to calling stub method

---

## Implementation Order

1. **Create test file** - Test skeleton with existing stub behavior
2. **Add `_setup_docks()`** - Create placeholder docks
3. **Add layout persistence** - QSettings save/restore/reset
4. **Add View menu** - Toggle and Reset Layout actions
5. **Update tests** - Cover new functionality
6. **Run pytest** - Verify all tests pass

---

## Risks & Mitigation

| Risk | Mitigation |
|------|------------|
| QSettings format changes break restore | Use version key, detect and reset on mismatch |
| Dock state corrupts and can't restore | Catch exception, fallback to default layout |
| Float button still appears via stylesheet | Hide via `setFeatures()` (controls behavior + appearance) |

---

## References

- `docs/UX_REDESIGN_PLAN.md` lines 246-266
- `src/casare_rpa/presentation/canvas/main_window.py` - Reference for MainWindow patterns
- `src/casare_rpa/presentation/canvas/ui_state_controller.py` - Reference for QSettings patterns
- `src/casare_rpa/presentation/canvas/theme_system/styles_v2.py` - V2 QSS

---

## Done When

- [ ] Docks exist (left, right, bottom)
- [ ] Docks are dock-only (no floatable)
- [ ] Layout persists across app restarts
- [ ] Reset Layout action works
- [ ] All tests pass
- [ ] No hardcoded colors
- [ ] Manual test checklist passes
