# Phase 0 Epic 0.1: Parallel UI Entry Implementation Plan

**Status**: APPROVED
**Created**: 2025-12-27
**Epic**: Create a parallel UI entry ("new shell") without breaking legacy

---

## Overview

Add a feature flag to launch either the legacy `MainWindow` or a new `NewMainWindow` stub, allowing both UIs to coexist during the UX redesign.

---

## Files to Create

| Path | Purpose | Lines |
|------|---------|-------|
| `src/casare_rpa/presentation/canvas/new_main_window.py` | NewMainWindow stub | ~80 |

## Files to Modify

| Path | Changes | Impact |
|------|---------|--------|
| `src/casare_rpa/presentation/canvas/app.py` | Add env var check, conditionally create window | ~30 |

---

## Implementation Details

### 1. Feature Flag Implementation

Add environment variable check in `app.py`:

```python
# In _setup_qt_application() or __init__
USE_UI_V2 = os.environ.get("CASARE_UI_V2", "0") == "1"
```

### 2. NewMainWindow Stub

Create minimal QMainWindow subclass:

```python
# src/casare_rpa/presentation/canvas/new_main_window.py

from PySide6.QtWidgets import QMainWindow, QWidget, QVBoxLayout, QLabel
from PySide6.QtCore import Qt

from ...utils.config import APP_NAME
from ..theme_system import THEME


class NewMainWindow(QMainWindow):
    """New UI shell - stub for Phase 0 Epic 0.1."""
    
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"{APP_NAME} [V2 Shell]")
        self.resize(1200, 800)
        
        # Central widget placeholder
        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)
        
        # Temporary label to distinguish from legacy
        label = QLabel("New UI Shell - Phase 0 Stub")
        label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        label.setStyleSheet(f"color: {THEME.text_primary}; font-size: 24px;")
        layout.addWidget(label)
    
    def set_central_widget(self, widget):
        """Set central widget (for graph compatibility)."""
        self.setCentralWidget(widget)
```

### 3. Integration Point in app.py

Modify `_create_ui()` method:

```python
def _create_ui(self) -> None:
    """Create main window and central widget."""
    from casare_rpa.presentation.canvas.graph.node_graph_widget import NodeGraphWidget
    
    # Feature flag: choose window class
    use_v2 = os.environ.get("CASARE_UI_V2", "0") == "1"
    
    if use_v2:
        from .new_main_window import NewMainWindow
        self._main_window = NewMainWindow()
        logger.info("Using V2 UI shell (stub)")
    else:
        self._main_window = MainWindow()
        logger.info("Using legacy MainWindow")
    
    self._startup_timer.mark("main_window_created")
    
    # Create node graph widget (shared between both UIs)
    self._node_graph = NodeGraphWidget()
    self._startup_timer.mark("graph_widget_created")
    
    # Set node graph as central widget
    self._main_window.set_central_widget(self._node_graph)
    
    # ... rest of existing code unchanged
```

### 4. Interface Compatibility

Both `MainWindow` and `NewMainWindow` must support the methods called by `app.py`:

| Method | Used By | Required |
|--------|---------|----------|
| `set_central_widget(widget)` | `_create_ui()` | Yes |
| `setWindowTitle(text)` | `__init__()` | Yes (QMainWindow built-in) |
| `set_controllers(**kwargs)` | `_initialize_components()` | Yes - stub required |
| `get_project_controller()` | `_connect_components()` | Yes - stub required |
| `set_workflow_data_provider()` | `_create_ui()` | Yes - stub required |
| `set_modified(bool)` | `_on_undo_stack_clean_changed()` | Yes - stub required |
| `show_status(text, duration)` | `_on_workflow_save/load()` | Yes - stub required |

**NewMainWindow stub methods** (Phase 0 only - will be expanded later):

```python
def set_controllers(self, **kwargs):
    """Store controllers (stub for Phase 0)."""
    self._controllers = kwargs

def get_project_controller(self):
    """Return None (no project controller in V2 stub yet)."""
    return None

def set_workflow_data_provider(self, provider):
    """Store data provider (stub)."""
    self._data_provider = provider

def set_modified(self, modified: bool):
    """Track modified state (stub)."""
    self._modified = modified

def show_status(self, message: str, duration: int = 3000):
    """Show status message (stub - use logger for now)."""
    logger.debug(f"[V2 Status] {message}")
```

---

## Test Approach

### Manual Test Steps

```bash
# Test 1: Legacy UI (default)
python run.py
# Expected: Normal MainWindow opens

# Test 2: V2 UI stub
set CASARE_UI_V2=1 && python run.py
# Or (PowerShell):
$env:CASARE_UI_V2="1"; python run.py

# Expected: NewMainWindow opens with placeholder label
```

### Verification Checklist

- [ ] App starts with `CASARE_UI_V2` unset (legacy)
- [ ] App starts with `CASARE_UI_V2=0` (legacy)
- [ ] App starts with `CASARE_UI_V2=1` (V2 stub)
- [ ] V2 stub window closes cleanly
- [ ] No crash on window title change
- [ ] Log message confirms which UI was loaded

---

## Risks and Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Missing method on NewMainWindow causes crash | HIGH | Create all required stub methods upfront |
| Env var check fails on non-standard platforms | LOW | Use `os.environ.get()` with default |
| Legacy UI broken by changes | MEDIUM | No changes to MainWindow class itself |
| V2 stub methods incomplete | MEDIUM | Add stubs for all methods called by app.py |

---

## Rollback Plan

If issues arise:

1. Remove `CASARE_UI_V2` check from `app.py`
2. Delete `new_main_window.py`
3. Restore original `app.py` from git

No impact on existing functionality - the flag defaults to legacy.

---

## Next Steps (After Epic 0.1)

1. Epic 1.1: Token spec v2
2. Epic 1.2: Font bundling
3. Epic 1.3: Global QSS v2
4. Epic 4.1: Full NewMainWindow implementation

---

## Estimated Effort

| Task | Time |
|------|------|
| Create NewMainWindow stub | 15 min |
| Modify app.py for feature flag | 15 min |
| Manual testing | 15 min |
| **Total** | **45 min** |

---

## References

- `docs/UX_REDESIGN_PLAN.md` - Full redesign plan
- `src/casare_rpa/presentation/canvas/app.py` - Entry point
- `src/casare_rpa/presentation/canvas/main_window.py` - Legacy window
- `src/casare_rpa/presentation/canvas/theme_system/` - Theme system
