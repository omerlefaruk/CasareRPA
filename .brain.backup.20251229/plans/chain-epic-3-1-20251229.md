# Implementation Plan: Epic 3.1 - PopupWindowBase (Draggable/Resizable + Click-Outside)

**Epic**: 3.1 - PopupWindowBase
**Created**: 2025-12-29
**Phase**: Phase 3 - PopupWindow Component Library
**Dependencies**: Epic 1.1 (Token spec v2), Epic 1.3 (Global QSS v2)

---

## Overview

Create a reusable `PopupWindowBase` class that all v2 popups will inherit from. The base class provides:
- Draggable header region (following NodeOutputPopup pattern)
- Optional resize grips (corners only)
- Click-outside-to-close (via PopupManager)
- Pin state integration
- Close-on-escape behavior
- Positioning helpers (anchor-to-widget + screen-boundary clamp)
- THEME_V2 styling (no animations, no shadows, crisp borders)

---

## Component Impact

### Canvas (src/casare_rpa/presentation/canvas/)
| File | Action | Description |
|------|--------|-------------|
| `ui/widgets/popups/__init__.py` | CREATE | New package for v2 popup components |
| `ui/widgets/popups/popup_window_base.py` | CREATE | Base class for all v2 popups |
| `ui/widgets/popups/_resize_grip.py` | CREATE | Corner resize grip widget (optional) |
| `managers/popup_manager.py` | MODIFY | Add `is_dragging()` check support |
| `theme_system/styles_v2.py` | MODIFY | Add `get_popup_styles_v2()` |
| `ui/__init__.py` | MODIFY | Export PopupWindowBase |

### No Impact To
- Robot (src/casare_rpa/infrastructure/robot/)
- Orchestrator (src/casare_rpa/infrastructure/orchestrator/)
- Domain layer

---

## Files to Create

### 1. `ui/widgets/popups/__init__.py`
```python
"""
V2 Popup Components Library.

Provides reusable base classes for all popup windows in the v2 UI.
All popups inherit from PopupWindowBase for consistent behavior.

Usage:
    from casare_rpa.presentation.canvas.ui.widgets.popups import PopupWindowBase

    class MyPopup(PopupWindowBase):
        def __init__(self, parent=None):
            super().__init__(
                title="My Popup",
                parent=parent,
                resizable=True,
                pin_button=True,
            )
"""

from .popup_window_base import PopupWindowBase

__all__ = ["PopupWindowBase"]
```

### 2. `ui/widgets/popups/popup_window_base.py` (CORE)
- **Class**: `PopupWindowBase(QWidget)`
- **Key Features**:
  - `PopupManager.register()` in `showEvent()`
  - `PopupManager.unregister()` in `closeEvent()`
  - Pin state with `PopupManager.register(self, pinned=True)`
  - Draggable header (from NodeOutputPopup.DraggableHeader pattern)
  - Corner resize grips (from NodeOutputPopup resize pattern)
  - Escape key handling (via eventFilter on children)
  - `show_at_anchor(widget, position=Position.BELOW)` helper
  - `show_at_position(global_pos)` with screen-boundary clamp
  - Uses THEME_V2 colors only
  - No animations (0ms)
  - No drop shadows

### 3. `ui/widgets/popups/_resize_grip.py` (OPTIONAL)
- **Class**: `ResizeGrip(QWidget)`
- Small widget for corner resize indicators
- Uses THEME_V2.border for visual feedback

### 4. `tests/presentation/canvas/ui/widgets/popups/test_popup_window_base.py`
- Test draggable header
- Test resize grips
- Test click-outside-to-close
- Test pin state (click-outside ignored when pinned)
- Test escape key closes
- Test screen-boundary clamping
- Test anchor positioning

---

## Files to Modify

### 1. `managers/popup_manager.py`
**Change**: Add class method to check if any popup is currently dragging
```python
@classmethod
def is_any_dragging(cls) -> bool:
    """Check if any registered popup is currently being dragged."""
    for popup in cls.get_instance()._active_popups:
        if hasattr(popup, "is_dragging") and popup.is_dragging():
            return True
    return False
```

**Reason**: Prevent click-outside-to-close from triggering during drag operations

### 2. `theme_system/styles_v2.py`
**Add**: `get_popup_styles_v2()` function
```python
def get_popup_styles_v2() -> str:
    """Generate QSS for PopupWindowBase (v2)."""
    return f"""
    PopupWindowBase {{
        background-color: {THEME_V2.bg_elevated};
        border: 1px solid {THEME_V2.border};
        border-radius: {TOKENS_V2.radius.md}px;
    }}
    PopupWindowBase #header {{
        background-color: {THEME_V2.bg_component};
        border-bottom: 1px solid {THEME_V2.border};
        border-top-left-radius: {TOKENS_V2.radius.md}px;
        border-top-right-radius: {TOKENS_V2.radius.md}px;
    }}
    ...
    """
```

### 3. `ui/__init__.py`
**Add**: Export PopupWindowBase
```python
from .widgets.popups import PopupWindowBase
```

---

## Agent Assignments

| Agent | Tasks | Parallel |
|-------|-------|----------|
| **architect** (current) | Create this plan | - |
| **builder** | Implement PopupWindowBase | After plan approval |
| **builder** | Add PopupManager.is_any_dragging() | Parallel with above |
| **quality** | Create test file + pytest | After implementation |
| **reviewer** | Code review gate | After tests pass |

---

## Parallel Opportunities

1. **Builder Phase** (can run in parallel):
   - Implement `popup_window_base.py`
   - Implement `_resize_grip.py`
   - Modify `popup_manager.py`
   - Modify `styles_v2.py`

2. **Test Creation** (parallel with implementation):
   - Write test cases while base class is being built
   - Create fixtures for popup testing

---

## API Design

### PopupWindowBase Constructor
```python
class PopupWindowBase(QWidget):
    """
    Base class for v2 popup windows.

    Signals:
        closed: Emitted when popup is closed
        pin_changed: Emitted when pin state changes (bool)

    Parameters:
        title: Header title text
        parent: Parent widget
        resizable: Enable corner resize grips (default: True)
        pin_button: Show pin button in header (default: True)
        close_button: Show close button in header (default: True)
        min_width: Minimum width constraint (default: 300)
        min_height: Minimum height constraint (default: 200)
    """

    closed = Signal()
    pin_changed = Signal(bool)

    def __init__(
        self,
        title: str = "Popup",
        parent: QWidget | None = None,
        resizable: bool = True,
        pin_button: bool = True,
        close_button: bool = True,
        min_width: int = 300,
        min_height: int = 200,
    ):
        ...
```

### Key Methods

#### Positioning
```python
def show_at_anchor(
    self,
    widget: QWidget,
    position: AnchorPosition = AnchorPosition.BELOW,
    offset: QPoint | None = None,
) -> None:
    """Show popup anchored to a widget with boundary clamping."""

def show_at_position(self, global_pos: QPoint) -> None:
    """Show popup at global position with screen-boundary clamping."""
```

#### State
```python
def set_pinned(self, pinned: bool) -> None:
    """Set pin state (pinned popups ignore click-outside)."""

def is_pinned(self) -> bool:
    """Check if popup is pinned."""

def is_dragging(self) -> bool:
    """Check if popup is currently being dragged."""
```

#### Styling
```python
def set_title(self, title: str) -> None:
    """Update header title."""

def set_content_widget(self, widget: QWidget) -> None:
    """Set the main content widget (replaces existing)."""
```

---

## Behavior Specifications

### Click-Outside-to-Close
1. PopupManager detects mouse press outside popup geometry
2. PopupManager calls `popup.close()`
3. Exception: If `is_pinned() == True`, ignore click-outside
4. Exception: If `is_any_dragging() == True`, ignore click-outside

### Pin State
1. Click pin button -> toggle `_is_pinned`
2. When pinned: `PopupManager.register(self, pinned=True)`
3. When unpinned: `PopupManager.register(self, pinned=False)`
4. Pin button shows pinned state (different icon/color)

### Close-on-Escape
1. Install eventFilter on all child widgets
2. Catch `QEvent.KeyPress` with `Qt.Key_Escape`
3. Call `self.close()`

### Dragging
1. Mouse press on header -> start drag
2. Mouse move -> update position
3. Mouse release -> end drag
4. Cursor: `Qt.SizeAllCursor` on header

### Resizing (Optional)
1. Mouse press on corner grip -> start resize
2. Mouse move -> update geometry (enforce min size)
3. Mouse release -> end resize
4. Cursor changes based on corner (diagonal cursors)

### Positioning Helpers
- `show_at_anchor()`: Position relative to widget (BELOW, ABOVE, LEFT, RIGHT)
- `show_at_position()`: Position at screen coords with clamp
- Screen clamp: Ensure popup stays within `QScreen.availableGeometry()`

---

## Dependencies Satisfied

| Dependency | How |
|------------|-----|
| Epic 1.1 (Token spec v2) | Uses THEME_V2 colors, TOKENS_V2 sizes |
| Epic 1.3 (Global QSS v2) | Adds popup styles to global stylesheet |

---

## Risks and Mitigation

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|-------|------------|
| Drag/close interaction conflicts | Medium | High | Use `is_dragging()` check in PopupManager |
| Z-order issues with NodeGraphQt | Low | Medium | Use `WindowStaysOnTopHint` conditionally |
| Resize grip visual overlap | Low | Low | Reserve 8px margin in layout |
| Memory leaks from event filters | Low | High | Remove filters in `closeEvent()` |
| DPI scaling issues | Medium | Medium | Use `QScreen.devicePixelRatio()` |

---

## Test Approach

### Unit Tests (pytest + PySide6)
```python
# test_popup_window_base.py

def test_popup_creation(qtbot):
    """Test basic popup creation."""
    popup = PopupWindowBase(title="Test")
    popup.show()
    assert popup.isVisible()
    assert popup.windowTitle() == ""  # Frameless

def test_click_outside_closes(qtbot):
    """Test click-outside-to-close behavior."""
    popup = PopupWindowBase(title="Test")
    popup.show()
    # Simulate click outside
    # Assert popup closed

def test_pinned_ignores_click_outside(qtbot):
    """Test pinned popups ignore click-outside."""
    popup = PopupWindowBase(title="Test")
    popup.set_pinned(True)
    popup.show()
    # Simulate click outside
    # Assert popup still visible

def test_escape_closes(qtbot):
    """Test Escape key closes popup."""
    popup = PopupWindowBase(title="Test")
    popup.show()
    QTest.keyClick(popup, Qt.Key_Escape)
    assert not popup.isVisible()

def test_draggable_header(qtbot):
    """Test header drags the window."""
    popup = PopupWindowBase(title="Test")
    popup.show()
    initial_pos = popup.pos()
    # Simulate drag on header
    # Assert position changed

def test_resize_grips(qtbot):
    """Test corner resize grips work."""
    popup = PopupWindowBase(title="Test", resizable=True)
    popup.show()
    initial_size = popup.size()
    # Simulate resize drag
    # Assert size changed

def test_screen_boundary_clamp(qtbot):
    """Test popup stays on screen."""
    popup = PopupWindowBase(title="Test")
    # Try to position off-screen
    popup.show_at_position(QPoint(-100, -100))
    # Assert clamped to screen bounds

def test_anchor_positioning(qtbot):
    """Test show_at_anchor positions correctly."""
    button = QPushButton("Anchor")
    popup = PopupWindowBase(title="Test")
    popup.show_at_anchor(button, AnchorPosition.BELOW)
    # Assert popup is below button
```

### Manual Test Checklist
- [ ] Popup opens at anchor position
- [ ] Click outside closes popup (unpinned)
- [ ] Click outside doesn't close (pinned)
- [ ] Escape key closes popup
- [ ] Header drags popup
- [ ] Resize grips resize popup (if enabled)
- [ ] Popup stays on screen when moved to edge
- [ ] Multiple popups don't interfere
- [ ] Pin button toggles visual state
- [ ] Close button works

---

## Implementation Order

1. **Step 1**: Create package structure (`popups/__init__.py`)
2. **Step 2**: Implement `PopupWindowBase` core (show/close/events)
3. **Step 3**: Implement draggable header
4. **Step 4**: Implement resize grips
5. **Step 5**: Modify `PopupManager` for drag check
6. **Step 6**: Add v2 popup styles
7. **Step 7**: Create tests
8. **Step 8**: Run tests and fix issues
9. **Step 9**: Code review
10. **Step 10**: Update docs

---

## Acceptance Criteria

A sample popup inheriting from `PopupWindowBase` must:
1. Open when `show()` is called
2. Close when clicking outside (unless pinned)
3. Close when pressing Escape
4. Drag when header is clicked-dragged
5. Resize from corner grips (if enabled)
6. Stay within screen boundaries
7. Use only THEME_V2 colors
8. Have no animations (0ms transitions)
9. Have no drop shadows
10. Register/unregister with PopupManager correctly

---

## Integration with Existing PopupManager

The `PopupWindowBase` integrates with the existing `PopupManager`:

```python
def showEvent(self, event):
    super().showEvent(event)
    PopupManager.register(self, pinned=self._is_pinned)

def closeEvent(self, event):
    PopupManager.unregister(self)
    self.closed.emit()
    super().closeEvent(event)
```

No changes to PopupManager's core API - only the optional `is_any_dragging()` helper.

---

## Rollback Plan

If issues arise:
1. Keep existing popups (NodeOutputPopup, VariablePickerPopup) unchanged
2. New v2 popups can opt-in to `PopupWindowBase`
3. Revert `PopupManager.is_any_dragging()` if not needed
4. Remove `get_popup_styles_v2()` from `styles_v2.py`

---

## Next Steps (After Epic 3.1)

Epic 3.2 will use `PopupWindowBase` to create:
- ContextMenu (Cursor-like right-click menu)
- Dropdown menu surface
- Tooltip / hint bubble
- Toast (auto-dismiss only, no animation)
- Inspector popover (for node output)
- Autocomplete popup

---

## References

- `docs/UX_REDESIGN_PLAN.md` - Phase 3 Epic 3.1
- `src/casare_rpa/presentation/canvas/managers/popup_manager.py` - Existing popup manager
- `src/casare_rpa/presentation/canvas/ui/widgets/node_output_popup.py` - Draggable header pattern
- `src/casare_rpa/presentation/canvas/ui/widgets/variable_picker.py` - Window flags pattern
- `src/casare_rpa/presentation/canvas/theme_system/tokens_v2.py` - V2 tokens
- `src/casare_rpa/presentation/canvas/theme_system/styles_v2.py` - V2 styles
