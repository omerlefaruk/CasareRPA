# Epic 4.2: Chrome - Top Toolbar + Status Bar v2 - Implementation Plan

**Created**: 2025-12-29
**Status**: ✅ COMPLETE
**Phase**: Phase 4 — IDE Shell v2
**Epic**: 4.2

---

## Scope

Build v2 Chrome components for NewMainWindow:
- **Toolbar v2**: Primary actions (New, Open, Save, Undo/Redo, Run/Stop, Settings)
- **StatusBar v2**: Connection status, robot status, execution status, zoom, cursor position
- VS Code/Cursor-like styling with THEME_V2 tokens
- IconProviderV2 (Lucide SVG) icons with accent state for Run/Stop

---

## Dependencies Met

| Epic | Status | Required |
|------|--------|----------|
| Epic 4.1 (NewMainWindow skeleton) | ✅ Complete | YES |
| Epic 2.1/2.2 (Icon system v2) | ✅ Complete | YES |
| Epic 1.1 (Token spec v2) | ✅ Complete | YES |
| Epic 1.3 (Global QSS v2) | ✅ Complete | YES |

---

## Files to Create

| File | Purpose |
|------|---------|
| `ui/chrome/__init__.py` | Chrome v2 package exports |
| `ui/chrome/toolbar_v2.py` | V2 MainToolbar with THEME_V2 styling |
| `ui/chrome/statusbar_v2.py` | V2 StatusBarManager with THEME_V2 styling |
| `tests/presentation/canvas/ui/chrome/test_toolbar_v2.py` | Toolbar tests |
| `tests/presentation/canvas/ui/chrome/test_statusbar_v2.py` | StatusBar tests |

---

## Files to Modify

| File | Changes |
|------|---------|
| `new_main_window.py` | Add `_setup_chrome()` method, integrate toolbar/statusbar |
| `ui/__init__.py` | Export ToolbarV2, StatusBarV2 |

---

## Implementation Details

### 1. ToolbarV2 Design

**Pattern**: Follow `MainToolbar` structure but with V2 styling

```python
class ToolbarV2(QToolBar):
    """V2 toolbar with THEME_V2 styling and IconProviderV2 icons."""

    # Signals (must match NewMainWindow workflow signals)
    new_requested = Signal()
    open_requested = Signal()
    save_requested = Signal()
    save_as_requested = Signal()
    run_requested = Signal()
    pause_requested = Signal()
    stop_requested = Signal()
    undo_requested = Signal()
    redo_requested = Signal()

    def __init__(self, parent: QWidget | None = None) -> None:
        super().__init__("Main", parent)
        self.setMovable(False)
        self.setFloatable(False)
        self.setIconSize(QSize(TOKENS_V2.sizes.icon_md, TOKENS_V2.sizes.icon_md))

        self._create_actions()
        self._apply_v2_styles()

    def _create_actions(self) -> None:
        """Create actions with IconProviderV2 icons."""
        # Use get_icon from icons_v2 with state="accent" for Run/Stop
        from casare_rpa.presentation.canvas.theme_system.icons_v2 import get_icon

        self.action_run = QAction(get_icon("play", size=20, state="accent"), "Run", self)
        # ... similar for other actions

    def _apply_v2_styles(self) -> None:
        """Apply THEME_V2 stylesheet (or use global styles_v2.py)."""
        # Use THEME_V2.toolbar_bg, toolbar_border, etc.
```

**Actions to include**:
- File: New, Open, Save, Save As
- Edit: Undo, Redo
- Execution: Run, Pause, Stop
- Settings (optional, for v2 chrome completeness)

### 2. StatusBarV2 Design

**Pattern**: Follow `StatusBarManager` structure but with V2 styling

```python
class StatusBarV2(QStatusBar):
    """V2 status bar with THEME_V2 styling."""

    def __init__(self, parent: QWidget | None = None) -> None:
        super().__init__(parent)
        self._create_widgets()
        self._apply_v2_styles()

    def _create_widgets(self) -> None:
        """Create status bar widgets with minimal v2 chrome."""
        # Right-aligned widgets (addPermanentWidget):
        # - Zoom display (compact label, no full widget initially)
        # - Execution status (Ready/Running/Paused/Error)
        # - Connection status (placeholder for Epic 4.3+)
        # - Robot status (placeholder for Epic 4.3+)

    def set_execution_status(self, status: str) -> None:
        """Update execution status with THEME_V2 colors."""

    def set_zoom(self, zoom_percent: float) -> None:
        """Update zoom display."""
```

**Status fields** (Epic 4.2 - minimal set):
- `exec_status_label` - "Ready" / "Running" / "Paused" / "Error"
- `zoom_label` - "100%" (or use existing ZoomWidget if needed)

**Future fields** (placeholders for later epics):
- Connection status (robot connection)
- Robot status
- Cursor position

### 3. NewMainWindow Integration

Add to `new_main_window.py`:

```python
def __init__(self, parent: QWidget | None = None) -> None:
    # ... existing code ...
    self._setup_window()
    self._setup_chrome()  # NEW
    self._setup_docks()
    self._setup_layout_persistence()

def _setup_chrome(self) -> None:
    """Create v2 toolbar and status bar."""
    from casare_rpa.presentation.canvas.ui.chrome import ToolbarV2, StatusBarV2

    # Toolbar
    self._toolbar = ToolbarV2(self)
    self.addToolBar(self._toolbar)
    self._connect_toolbar_signals()

    # Status bar
    self._status_bar = StatusBarV2(self)
    self.setStatusBar(self._status_bar)

    logger.debug("NewMainWindow: v2 chrome initialized")

def _connect_toolbar_signals(self) -> None:
    """Connect toolbar signals to NewMainWindow workflow signals."""
    toolbar = self._toolbar
    toolbar.new_requested.connect(self.workflow_new.emit)
    toolbar.open_requested.connect(self.workflow_open.emit)
    # ... similar for other signals
```

### 4. THEME_V2 Styling

**Use existing QSS from `styles_v2.py`:**
- `get_toolbar_styles_v2()` - Already defined
- `get_statusbar_styles_v2()` - Already defined

**No inline QSS needed** - global stylesheet applies automatically.

---

## Code Changes Summary

### new_main_window.py

**Add after `_setup_window()`**:
1. `_setup_chrome()` - Create toolbar and status bar
2. `_connect_toolbar_signals()` - Wire toolbar to workflow signals
3. `self._toolbar: ToolbarV2 | None` - Instance variable
4. `self._status_bar: StatusBarV2 | None` - Instance variable

**Modify `__init__`**:
- Add `self._setup_chrome()` call

**Add public API**:
- `set_execution_state(is_running, is_paused)` - Proxy to toolbar
- `set_execution_status(status)` - Proxy to status bar
- `set_undo_enabled(enabled)` - Proxy to toolbar
- `set_redo_enabled(enabled)` - Proxy to toolbar
- `update_zoom(zoom_percent)` - Proxy to status bar

---

## Tests to Create

### tests/presentation/canvas/ui/chrome/test_toolbar_v2.py

```python
@pytest.mark.ui
class TestToolbarV2Creation:
    """Test toolbar instantiation."""

    def test_creates_with_qapp(self, qapp):
        toolbar = ToolbarV2()
        assert toolbar.windowTitle() == "Main"
        assert not toolbar.isMovable()
        assert not toolbar.isFloatable()

@pytest.mark.ui
class TestToolbarV2Actions:
    """Test toolbar actions."""

    def test_all_actions_exist(self, qapp):
        toolbar = ToolbarV2()
        required = [
            "action_new", "action_open", "action_save",
            "action_run", "action_stop", "action_undo", "action_redo",
        ]
        for name in required:
            assert hasattr(toolbar, name)

    def test_run_emits_signal(self, qapp, signal_capture):
        toolbar = ToolbarV2()
        toolbar.run_requested.connect(signal_capture.slot)
        toolbar.action_run.trigger()
        assert signal_capture.called

@pytest.mark.ui
class TestToolbarV2State:
    """Test execution state management."""

    def test_running_state_disables_run(self, qapp):
        toolbar = ToolbarV2()
        toolbar.set_execution_state(is_running=True)
        assert not toolbar.action_run.isEnabled()
        assert toolbar.action_stop.isEnabled()

    def test_undo_redo_enabled(self, qapp):
        toolbar = ToolbarV2()
        toolbar.set_undo_enabled(True)
        assert toolbar.action_undo.isEnabled()
```

### tests/presentation/canvas/ui/chrome/test_statusbar_v2.py

```python
@pytest.mark.ui
class TestStatusBarV2Creation:
    """Test status bar instantiation."""

    def test_creates_with_qapp(self, qapp):
        bar = StatusBarV2()
        assert bar.exec_status_label.text() == "Ready"

@pytest.mark.ui
class TestStatusBarV2Updates:
    """Test status bar updates."""

    def test_execution_status_changes(self, qapp):
        bar = StatusBarV2()
        bar.set_execution_status("running")
        assert "Running" in bar.exec_status_label.text()

    def test_zoom_display_updates(self, qapp):
        bar = StatusBarV2()
        bar.set_zoom(150.0)
        assert "150" in bar.zoom_label.text()
```

---

## Manual Test Checklist

- [ ] Toolbar appears at top of NewMainWindow
- [ ] All buttons have correct icons (Lucide SVG via IconProviderV2)
- [ ] Run/Stop buttons use accent color (blue)
- [ ] Buttons have hover effects
- [ ] Keyboard shortcuts work (Ctrl+N, Ctrl+O, F5, etc.)
- [ ] Run button disabled during execution
- [ ] Stop button enabled during execution
- [ ] Status bar appears at bottom
- [ ] Execution status updates (Ready → Running → Complete)
- [ ] Zoom display shows current zoom level
- [ ] No hardcoded colors in code
- [ ] VS Code/Cursor-like appearance

---

## Rollback Plan

1. **Toggle**: Remove `_setup_chrome()` call from `__init__` (1 min)
2. **Import revert**: Delete toolbar_v2.py, statusbar_v2.py (5 min)
3. **Full revert**: Restore new_main_window.py before chrome changes (10 min)

---

## Implementation Order

1. **Create package** - `ui/chrome/__init__.py`
2. **Create ToolbarV2** - `ui/chrome/toolbar_v2.py`
3. **Create StatusBarV2** - `ui/chrome/statusbar_v2.py`
4. **Integrate** - Modify `new_main_window.py` `_setup_chrome()`
5. **Create tests** - `test_toolbar_v2.py`, `test_statusbar_v2.py`
6. **Run pytest** - Verify all tests pass
7. **Manual test** - Run app with `CASARE_UI_V2=1`

---

## Risks & Mitigation

| Risk | Mitigation |
|------|------------|
| Icon loading fails | Graceful fallback to Qt standard icons |
| Toolbar signal wiring mismatch | Verify signal names match NewMainWindow |
| Status bar widget integration | Use simple labels initially, add complexity later |

---

## References

- `docs/UX_REDESIGN_PLAN.md` lines 279-295
- `src/casare_rpa/presentation/canvas/ui/toolbars/main_toolbar.py` - Reference implementation
- `src/casare_rpa/presentation/canvas/components/status_bar_manager.py` - Reference implementation
- `src/casare_rpa/presentation/canvas/theme_system/icons_v2.py` - Icon provider
- `src/casare_rpa/presentation/canvas/theme_system/styles_v2.py` - V2 QSS

---

## Done When

- [ ] ToolbarV2 created with all required actions
- [ ] StatusBarV2 created with execution status + zoom
- [ ] Both integrated into NewMainWindow
- [ ] All tests pass
- [ ] No hardcoded colors (uses THEME_V2)
- [ ] Manual test checklist passes
