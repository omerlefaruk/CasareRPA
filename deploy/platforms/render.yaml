# CasareRPA Cloud Orchestrator - Render Blueprint
# https://render.com/docs/blueprint-spec
#
# DEPLOYMENT:
#   1. Fork/push repository to GitHub
#   2. Go to https://dashboard.render.com/blueprints
#   3. Click "New Blueprint Instance"
#   4. Connect your repository
#   5. Select this render.yaml file
#   6. Set secrets in dashboard: API_SECRET, SUPABASE_URL, SUPABASE_KEY
#   7. Deploy
#
# DATABASE_URL and REDIS_URL are auto-populated from services below.

services:
  # ==========================================================================
  # Orchestrator Web Service
  # ==========================================================================
  - type: web
    name: casare-orchestrator
    runtime: docker
    dockerfilePath: ./deploy/docker/Dockerfile
    dockerContext: .
    dockerTarget: orchestrator-cloud

    # Instance configuration
    plan: starter  # starter, standard, pro
    region: oregon  # oregon, ohio, frankfurt, singapore

    # Scaling (Render Pro feature)
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 80
      targetCPUPercent: 70

    # Health check
    healthCheckPath: /health

    # Environment variables
    envVars:
      # Server
      - key: PORT
        value: 8000
      - key: HOST
        value: "0.0.0.0"
      - key: WORKERS
        value: "1"

      # Database (auto-populated from database service)
      - key: DATABASE_URL
        fromDatabase:
          name: casare-db
          property: connectionString

      # Redis (auto-populated from Redis service)
      - key: REDIS_URL
        fromService:
          name: casare-redis
          type: redis
          property: connectionString

      # Security (set in Render dashboard)
      - key: API_SECRET
        sync: false  # Must be set manually

      # Supabase (optional)
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false

      # CORS
      - key: CORS_ORIGINS
        value: "*"

      # Timeouts
      - key: ROBOT_HEARTBEAT_TIMEOUT
        value: "90"
      - key: JOB_TIMEOUT_DEFAULT
        value: "3600"

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  - type: pserv
    name: casare-db
    runtime: postgresql
    plan: starter  # starter, standard, pro
    region: oregon

    databaseName: casare_rpa
    user: casare

    # Backup configuration (Pro feature)
    # backupSchedule: "@daily"
    # backupRetention: 7

  # ==========================================================================
  # Redis (Optional - for high-scale queue)
  # ==========================================================================
  - type: redis
    name: casare-redis
    plan: starter  # starter, standard, pro
    region: oregon
    maxmemoryPolicy: allkeys-lru
