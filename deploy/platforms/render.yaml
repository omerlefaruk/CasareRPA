# CasareRPA Cloud Orchestrator - Render.com Configuration
# https://render.com/docs/deploy-docker
#
# DEPLOYMENT:
#   1. Push this file to GitHub
#   2. Create new Blueprint on Render dashboard
#   3. Connect GitHub repo
#   4. Select this blueprint (render.yaml)
#   5. Render will auto-create:
#      - PostgreSQL database
#      - Web service with Docker image
#   6. Set environment variables in dashboard as needed
#
# Note: Render reads render.yaml for all configuration

services:
  - type: redis
    name: casare-redis
    region: oregon  # or closest to you
    plan: starter
    maxmemoryPolicy: allkeys-lru

  - type: pserv
    name: casare-db
    runtime: postgres
    plan: starter
    region: oregon
    databaseName: casare_rpa
    user: casare
    version: "16"
    ipAllowList:
      - source: 0.0.0.0/0
        description: "Allow all (restrict in production)"

  - type: web
    name: casare-orchestrator
    runtime: docker
    plan: starter
    region: oregon
    dockerfile: ./deploy/docker/Dockerfile
    dockerCommand: "uvicorn casare_rpa.infrastructure.orchestrator.api.main:app --host 0.0.0.0 --port $PORT --workers 2"
    buildArgsFile: ./deploy/platforms/render-build-args.txt
    envVars:
      - key: HOST
        value: "0.0.0.0"
      - key: WORKERS
        value: "2"
      - key: CASARE_ENV
        value: production
      - key: CASARE_LOG_LEVEL
        value: INFO
      - key: ROBOT_HEARTBEAT_TIMEOUT
        value: "90"
      - key: JOB_TIMEOUT_DEFAULT
        value: "3600"
      - key: WS_PING_INTERVAL
        value: "30"
      - key: CORS_ORIGINS
        value: "*"
      # Database URL injected from PostgreSQL service
      - key: DATABASE_URL
        fromDatabase:
          name: casare-db
          property: connectionString
      # Redis URL injected from Redis service
      - key: REDIS_URL
        fromService:
          name: casare-redis
          property: connectionString
      # Secrets (set in Render dashboard)
      - key: JWT_SECRET_KEY
        scope: RUN_AND_BUILD
      - key: API_SECRET
        scope: RUN_AND_BUILD
    healthCheckPath: /health/live
    healthCheckTimeout: 10
    healthCheckPollInterval: 30
    routes:
      - path: /
        service: casare-orchestrator
