# Production security patches
# Enhanced security policies for production

---
# Strict network policy - only allow required traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Production-grade orchestrator network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-orchestrator-ingress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: casare-orchestrator
  policyTypes:
    - Ingress
  ingress:
    # Only allow from nginx ingress in production
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8001
    # Allow from robot pods
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: robot
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8001
    # Allow Prometheus from monitoring namespace only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9090

---
# Resource quotas for the namespace
apiVersion: v1
kind: ResourceQuota
metadata:
  name: casare-rpa-quota
spec:
  hard:
    requests.cpu: "50"
    requests.memory: 100Gi
    limits.cpu: "100"
    limits.memory: 200Gi
    pods: "200"
    services: "20"
    secrets: "50"
    configmaps: "50"

---
# Limit ranges for pods
apiVersion: v1
kind: LimitRange
metadata:
  name: casare-rpa-limits
spec:
  limits:
    - type: Pod
      max:
        cpu: "8"
        memory: 16Gi
    - type: Container
      default:
        cpu: 500m
        memory: 512Mi
      defaultRequest:
        cpu: 100m
        memory: 128Mi
      max:
        cpu: "4"
        memory: 8Gi
      min:
        cpu: 50m
        memory: 64Mi
