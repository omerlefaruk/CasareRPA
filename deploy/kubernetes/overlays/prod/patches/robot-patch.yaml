# Production robot patches
# High throughput configuration
apiVersion: apps/v1
kind: Deployment
metadata:
  name: casare-browser-robot
spec:
  replicas: 5
  template:
    spec:
      containers:
        - name: robot
          resources:
            requests:
              cpu: 750m
              memory: 2Gi
            limits:
              cpu: 3000m
              memory: 6Gi
          volumeMounts:
            - name: browser-data
              mountPath: /home/casare/.local/share/chromium
            - name: tmp
              mountPath: /tmp
            - name: downloads
              mountPath: /home/casare/downloads
      volumes:
        - name: browser-data
          emptyDir:
            sizeLimit: 4Gi
        - name: tmp
          emptyDir:
            sizeLimit: 2Gi
        - name: downloads
          emptyDir:
            sizeLimit: 10Gi

---
# Production KEDA scaling - full capacity
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: casare-robot-scaler
spec:
  minReplicaCount: 5
  maxReplicaCount: 100
  triggers:
    - type: postgresql
      metadata:
        connectionFromEnv: DATABASE_URL
        query: "SELECT COUNT(*) FROM job_queue WHERE status = 'pending' AND robot_type = 'browser'"
        targetQueryValue: "5"
        activationTargetQueryValue: "2"
    # Business hours scaling
    - type: cron
      metadata:
        timezone: America/New_York
        start: "0 8 * * 1-5"
        end: "0 18 * * 1-5"
        desiredReplicas: "30"
    # Off-hours scaling
    - type: cron
      metadata:
        timezone: America/New_York
        start: "0 18 * * 1-5"
        end: "0 8 * * 1-5"
        desiredReplicas: "10"
    # Weekend scaling
    - type: cron
      metadata:
        timezone: America/New_York
        start: "0 0 * * 0,6"
        end: "0 0 * * 1"
        desiredReplicas: "5"

---
# Production PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: casare-robot-pdb
spec:
  minAvailable: 3
