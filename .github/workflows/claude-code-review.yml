name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    name: Code Review with Claude

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install anthropic requests

      - name: Get PR diff
        id: pr-diff
        run: |
          git diff HEAD^ HEAD > pr_diff.txt
          echo "Diff saved to pr_diff.txt"

      - name: Review with Claude
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'PYTHON_SCRIPT'
          import os
          import anthropic
          import requests

          # Read the diff
          with open('pr_diff.txt', 'r') as f:
              diff_content = f.read()

          if not diff_content.strip():
              print("No changes detected")
              exit(0)

          # Get OAuth token
          oauth_token = os.environ.get('CLAUDE_CODE_OAUTH_TOKEN')

          if not oauth_token:
              print("Error: CLAUDE_CODE_OAUTH_TOKEN not found in secrets")
              exit(1)

          # Call Claude API with OAuth token
          client = anthropic.Anthropic(
              auth_token=oauth_token
          )

          message = client.messages.create(
              model="claude-sonnet-4-5-20250929",
              max_tokens=4096,
              messages=[{
                  "role": "user",
                  "content": f"""Review this code diff and provide feedback on:
          - Security vulnerabilities
          - Code quality and best practices
          - Performance issues
          - Bug detection
          - Type safety

          Diff:
          ```
          {diff_content[:15000]}
          ```

          Provide a concise review with specific line references where applicable."""
              }]
          )

          review_comment = message.content[0].text

          # Post comment to PR
          pr_number = os.environ['PR_NUMBER']
          repo = os.environ['REPO']
          github_token = os.environ['GITHUB_TOKEN']

          url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          headers = {
              "Authorization": f"token {github_token}",
              "Accept": "application/vnd.github.v3+json"
          }
          data = {
              "body": f"## Claude Code Review\n\n{review_comment}\n\n---\n*Automated review by Claude Code*"
          }

          response = requests.post(url, json=data, headers=headers)
          if response.status_code == 201:
              print("Review posted successfully!")
          else:
              print(f"Failed to post review: {response.status_code}")
              print(response.text)
          PYTHON_SCRIPT