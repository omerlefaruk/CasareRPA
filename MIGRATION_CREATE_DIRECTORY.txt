@node_schema(
    PropertyDef(
        "directory_path",
        PropertyType.STRING,
        required=True,
        label="Directory Path",
        tooltip="Path to the directory to create",
        placeholder="C:\\path\\to\\directory",
    ),
    PropertyDef(
        "parents",
        PropertyType.BOOLEAN,
        default=True,
        label="Create Parents",
        tooltip="Create parent directories as needed",
    ),
    PropertyDef(
        "exist_ok",
        PropertyType.BOOLEAN,
        default=True,
        label="Exist OK",
        tooltip="Don't error if directory already exists",
    ),
    PropertyDef(
        "allow_dangerous_paths",
        PropertyType.BOOLEAN,
        default=False,
        label="Allow Dangerous Paths",
        tooltip="Allow access to system directories",
    ),
)
@executable_node
class CreateDirectoryNode(BaseNode):
    """
    Create a directory.

    Config (via @node_schema):
        directory_path: Path to create (required)
        parents: Create parent directories as needed (default: True)
        exist_ok: Don't error if directory exists (default: True)
        allow_dangerous_paths: Allow system paths (default: False)

    Inputs:
        directory_path: Path override (if connected)

    Outputs:
        dir_path: Created directory path
        success: Whether operation succeeded
    """

    def __init__(self, node_id: str, name: str = "Create Directory", **kwargs) -> None:
        # Config auto-merged by @node_schema decorator
        config = kwargs.get("config", {})
        super().__init__(node_id, config)
        self.name = name
        self.node_type = "CreateDirectoryNode"

    def _define_ports(self) -> None:
        self.add_input_port("directory_path", PortType.INPUT, DataType.STRING)
        self.add_output_port("dir_path", PortType.OUTPUT, DataType.STRING)
        self.add_output_port("success", PortType.OUTPUT, DataType.BOOLEAN)

    async def execute(self, context: ExecutionContext) -> ExecutionResult:
        self.status = NodeStatus.RUNNING

        try:
            # NEW: Unified parameter accessor
            dir_path = self.get_parameter("directory_path")
            parents = self.get_parameter("parents", True)
            exist_ok = self.get_parameter("exist_ok", True)
            allow_dangerous = self.get_parameter("allow_dangerous_paths", False)

            if not dir_path:
                raise ValueError("directory_path is required")

            # Resolve {{variable}} patterns in dir_path
            dir_path = context.resolve_value(dir_path)

            # SECURITY: Validate path before directory creation
            path = validate_path_security(dir_path, "mkdir", allow_dangerous)
            path.mkdir(parents=parents, exist_ok=exist_ok)

            self.set_output_value("dir_path", str(path))
            self.set_output_value("success", True)
            self.status = NodeStatus.SUCCESS

            return {
                "success": True,
                "data": {"dir_path": str(path)},
                "next_nodes": ["exec_out"],
            }

        except PathSecurityError as e:
            self.set_output_value("success", False)
            self.status = NodeStatus.ERROR
            logger.error(f"Security violation in CreateDirectoryNode: {e}")
            return {"success": False, "error": str(e), "next_nodes": []}

        except Exception as e:
            self.set_output_value("success", False)
            self.status = NodeStatus.ERROR
            return {"success": False, "error": str(e), "next_nodes": []}

    def _validate_config(self) -> tuple[bool, str]:
        return True, ""
